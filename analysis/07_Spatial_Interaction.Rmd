---
title: "Settlement Persistence Project, SBOM Script #7:"
subtitle: "Modeling Spatial Interactions"
author: "Rudolf Cesaretti"
date: "Last run on `r Sys.Date()`"
output:
  html_document:
    toc: true
    df_print: paged
    number_sections: true
bibliography: References.bib
csl: apa.csl
link-citations: yes
---


```{css, echo=FALSE}
pre {
  max-height: 300px;
  overflow-y: auto;
}

pre[class] {
  max-height: 300px;
}
```

```{r, setup, include=FALSE,echo=FALSE, message=FALSE,warning=FALSE}
require(knitr)
# Set so that long lines in R will be wrapped:
opts_chunk$set(tidy.opts=list(width.cutoff=75),tidy=TRUE)
#
rm(list = ls())
```

I do four things in this R markdown document: 

  3. Calculate settlement hierarchy metrics for AggSites at two spatial scales:
      + The global level (SBOM-region-wide) 
      + The local level (at a set radius surrounding each site)
  4. Reorganize the data and export for Script #7
  
  
# Setup 

All of the data and scripts are downloadable from the [new ASU SettlementPersist2022 github repository](https://https://github.com/rcesaret/ASUSettlementPersist2022), which can be downloaded locally as a .zip folder or cloned to your own account.

Either way, once you have done so, you will need to modify the working directory (setwd("C:/...)") path and "dir" variables in the code chunk below to match the repository location on your computer.

```{r, label='Set Local Directory Location', message=FALSE,warning=FALSE}

wd <- list()

#SET YOUR LOCAL DIRECTORY LOCATION HERE:
wd$dir <- "C:/Users/rcesaret/Dropbox (ASU)/ASUSettlementPersist2022/"
#wd$dir <- "C:/Users/TJ McMote/Dropbox (ASU)/ASUSettlementPersist2022"

wd$analysis <- paste0(wd$dir,"analysis/")
wd$data_r <- paste0(wd$dir,"data-raw/")
wd$data_p <- paste0(wd$dir,"data-processed/")
wd$data_f <- paste0(wd$dir,"data-final-outputs/")
wd$figs <- paste0(wd$dir,"figures/")
wd$funcs <- paste0(wd$dir,"functions/")

```


## Load R Packages and Custom Functions

```{r, label='Load Libraries', message=FALSE,warning=FALSE}
# Package names
packages <- c("rgdal", "rgeos", "sp", "sf", "GISTools", "raster", "Matrix", 
              "gdistance", "lwgeom", "tidyverse", "tidyr", "pacman", 
              "data.table", "RColorBrewer", "cowplot", "stars", "ggnewscale", 
              "scales", "igraph", "tidygraph", "centiserve", "CINNA", 
              "sfnetworks", "gravity", "moin", "spflow", "simodels", "viridis")#, "zoo", "mgcv", "ggrepel", "ggridges", "movecost"

# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

# load packages
invisible(lapply(packages, library, character.only = TRUE))

rm(packages,installed_packages)

#Read in custom R functions located in the wd$funcs directory folder
FUNCS <- list("splitByAttributes.R", "Radiation_EstFlows.R", "net_stats2.R")#,  "SpInt_EstFlows.R"
invisible(lapply(FUNCS, function(x) source(paste0(wd$funcs,x))))
rm(FUNCS)

```



## Import Data

Data we are importing:

  1. the AggSite polygon data
  2. A simple polygon calculated in QGIS that specifies a hard outter border for the catchment areas of sites (constructed for sensitivity to survey borders and sites not included in the SBOM sample)
  3. Cost-distance matrices from script #3
  4. Least cost path rasters from script #3
  5. A raster hillshade basemap for the SBOM which includes the lakes

```{r, label='Import Data', message=FALSE,warning=FALSE}

#Agg Site and catchment polygon data
All_AggPoly <- readOGR(paste0(wd$data_p,"SBOM_AggSitePoly6.gpkg"))
All_CatchPoly <- readOGR(paste0(wd$data_p,"SBOM_CatchPoly6.gpkg"))
#reorder spatial polygons dataframes by period
All_AggPoly <- All_AggPoly[order(All_AggPoly$PeriodNum),]
All_CatchPoly <- All_CatchPoly[order(All_CatchPoly$PeriodNum),]

# Split polygons by Phase, saved as list of SPDFs
Poly_List <- splitByAttributes(spdata = All_AggPoly, attr = "Period", suffix="_SitePoly") 
Catch_List <- splitByAttributes(spdata = All_CatchPoly, attr = "Period", suffix="_CatchPoly") 

# convert spatial polygons dataframe to spatial points dataframe
coor = All_AggPoly@data[,c("East","North")] #create separate dataframe of coordinates
rownames(coor) <- as.numeric(rownames(coor)) #make sure rownames match
All_AggPts <- SpatialPointsDataFrame(coor, All_AggPoly@data, match.ID = TRUE) #convert to points
proj4string(All_AggPts) <- CRS("+proj=utm +zone=14 +datum=NAD83 +units=m +no_defs") #set CRS
All_AggPts = as(st_make_valid(st_as_sf(All_AggPts)), "Spatial") #make sure geometry is valid
All_AggPts <- All_AggPts[order(All_AggPts$PeriodNum),]#reorder by period

# Split points by Phase, saved as list of spatial points dataframes
Pts_List <- splitByAttributes(spdata = All_AggPts, attr = "Period", suffix="_Pts")

#Catchment boundary limit polygon
CatchLims <- readOGR(paste0(wd$data_r,"CatchLims.gpkg"))
CatchLims.sf = st_as_sf(CatchLims) #for ggplot 

## Hillshade Basemap Raster with lake
HillshadeLake <- raster(paste0(wd$data_r, "HillshadeLake.tif"))
HillshadeLake <- rast(HillshadeLake, crs = 26914)
Hillshade.s <- st_as_stars(HillshadeLake) #for ggplot basemap

#Cost-distance matrices
CD.mats <- readRDS(file=paste0(wd$data_p,"CDmats_list.RData"))
TrsprtNet_CDmatList <- readRDS(file=paste0(wd$data_p,"TrsprtNet_CDmatList.RData"))

TrsprtNet_lines_sfList <- readRDS(file=paste0(wd$data_p,"TrsprtNet_lines_sfList.RData"))
```


# Modelling Interactions

Model different theoretical dimensions of interaction
--using well-established covariates and proxies
--using high-performing models 



Radiation Model 
--to model the distance decay function for different spatial interactions

Spatial Interaction Models
--Retail Model
--Doubly Constrained



LQs or similar of

--Primary Sector Trade
----AG staple
----AG type trade
----Naural resources trade
--Urban productivity specialization
----Popdens, Agglom Index, Scaling Residuals
----Transp Network centrality
----Pop Rural/Urbanization vars
----


https://cran.r-project.org/web/packages/ggiraphExtra/vignettes/ggPredict.html


## Radiation Models

### Background

This model was created explicitly as an alternative to various gravity models and, in certain cases, was demonstrated to generate improved empirical predictions of human population movement between origins and destinations. This model shares some basic features with gravity models but importantly, the approach includes no parameters at all. Instead, this model uses simply measures of population at a set of sites and the distances between them. 

Model of socioeconomic spatial interaction 

  * commuting to work
  * migrating (changing residence and employment)
  * All travel (incl. shopping trips, business and recreation)
  * communication (cell phone calls)
  * trade

This model is inspired by a diffusion model where each individual living in an unit i has a certain probability of being “absorbed” by another unit j according to the spatial distribution of socioeconomic opportunities. The original radiation model is free of parameters and, therefore, it does not require calibration. The conditional interaction (radiation/absorbtion) probability is
$$
\mathrm{P}(1 \mid m_i, m_j, s_{ij}) = \frac{m_in_j}{(m_i + s_{ij})(m_i + n_j + s_{ij})}
$$
where $m_i$ is the origin population, $n_j$ is the destination population, and $s_{ij}$ is the total population of all other competing destinations within a circle centered at origin $i$ whose radius is the distance between origin $i$ and destination $j$. 

This generalized probability of interaction is then parameterized by the scalar $T_i$, representing the magnitude of all outgoing 'interactions' in some dimension (e.g. commuters, travelers, migrants, etc.), to obtain the estimated total directional flow from origin $i$ to destination $j$, $T_{ij}$, given by
$$
T_{ij} = T_i \frac{m_in_j}{(m_i + s_{ij})(m_i + n_j + s_{ij})}
$$
Of course, the magnitude of $T_i$ is empirically variable by dimension and locale, but is necessarily proportional to the population $m_i$ of origin $i$. Their analysis suggested that most dimensions were proportional to population (phone data and freight transportation were not due to sampling bias), and, critically, that they were independent of both the spatial density of employment and the spatial cost-benefit distribution of employment. Simini et al. [-@Simini2012] therefore suggest that the variability of $T_i$ is scale invariant, such that
$$
T_{ij} =\gamma m_i\frac{m_in_j}{(m_i + s_{ij})(m_i + n_j + s_{ij})} \propto \frac{m_i^2 n_j}{(m_i + s_{ij})(m_i + n_j + s_{ij})}
$$
where $\gamma$, the local fraction of outgoing interactions, as the only unknown parameter. Given their assertion that this is stochastic, dimensional, scale-invariant, and independent of intervening employment opportunity, population can be used as a proxy. As such, the model becomes parameter-free since the spatial interaction flux probability is not dependent on $\gamma$.

Since its publication, further tests and analyses have led to revisions/adaptations of the model. 
Masucci et al. [-@Masucci2013] analyze different data suggesting that $T_i = \gamma m_i$ is in fact scale dependent, changing the model to
$$
T_{ij} = \frac{T_i}{1-\frac{m_i}{M}} \frac{m_in_j}{(m_i + s_{ij})(m_i + n_j + s_{ij})}
$$
where $M$ is the origin's fraction of total regional population. Indeed, such a gravitational size effect is to be expected theoretically given ubiquitous conditions of spatial heterogeneity, increasing returns to scale in urban agglomeration effects, and heavily right-skew city size distributions [@Masucci2013].

Other analysts have demonstrated that the radiation model greatly underperforms exponential gravity models at smaller spatial scales [@Lenormand2012; @Liang2013]. While the radiation model achieves the best predictions at long distances, these flows are much lower volume and a small fraction of the total [@Lenormand2016]. To account for this, the original authors [@Yang2014] propose an extended radiation model with the flux probability given by
$$
\mathrm{P}(1 \mid m_i, m_j, s_{ij}) = \frac{[(m_i+n_j+s_{ij})^\alpha - (m_i+s_{ij})^\alpha]~(m_i^\alpha+1)}{[(m_i + s_{ij})^\alpha+1]~~[(m_i + n_j + s_{ij})^\alpha+1]}
$$
where the new parameter, $\alpha$, models the impact of rival employment opportunities between origin and destination. To calibrate the $\alpha$ parameter in the absence of data, Yang et al. [-@Yang2014] follow gravity model methods to propose $\alpha$ as proportional to the average commuting distance, $l$, assumed to be the radius of the average area of the spatial units of analysis (census tracts). This makes $l= \sqrt{A} $, which enabled them to estimate from empirical data the average value of alpha as $\alpha=0.0085~l^{1.33} $. For the modern data, MSA-scale values of $\alpha$ ranged between 0 and 2. 


We have defined a function for calculating radiation among a set of sites using just two inputs:

* **`pop`** is a vector of population values.
* **`d_mat`** is a distance matrix among all nodes.

```{r}
test = Radiation_EstFlows(df = Poly_List[[5]]@data,
                       var = "Population.s2",
                       d_mat = TrsprtNet_CDmatList[[5]], 
                       xcoords = Poly_List[[5]]@data$East,
                       ycoords = Poly_List[[5]]@data$North,
                       crs_coords = 26914,
                       extended = F, #T
                       alpha = 1.2,
                       scale = "invariant", #c("invariant", "variant", "none")
                       commuters = "var", #c("var", "input", "none")
                       Ti_input = NULL,
                       outputs = c("adjmat", "igraph", "sflines", "sfpts_netstats"))#, "sfnetwork"

ggplot(test$sflines, aes(Tij)) +
  geom_histogram(color = "#000000", fill = "thistle1", bins = 20) +
  labs(x = "Interaction Flows (T_ij)", y = "Frequency",
       title = "Radiation Model Interaction Flows: Late Formative SBOM (400-200 BC)",
       subtitle = "Scale Invariant Original Model with Commuters as Population") +
  scale_x_continuous(trans = log_trans(), breaks = trans_breaks(n = 10, "log", function(x) exp(x)),
                     labels = label_number(accuracy =0.001))+
  theme_bw()+
  theme(plot.title=element_text(hjust = 0.5, size=14, face="bold"),
        plot.subtitle = element_text(hjust = 0.5, face="bold", size=12),
        axis.title.x = element_text(color="black", size=12, face="bold"),
        axis.title.y = element_text(color="black", size=12, face="bold"),
        axis.text.y = element_text(color="black", size=12),
        axis.text.x = element_text(color="black", size=9, angle=20))

hist(log(test$sfpts_netstats$Rad_centr_indeg))

fit_power_law(test$sfpts_netstats$Rad_centr_indeg)

ggplot(data = test$sfpts_netstats,aes(x = Population.s2, y = Rad_centr_totdeg)) +
  geom_point(size=2) +
  geom_smooth(method = "glm", formula = y~x,method.args = list(family = gaussian()))+
  scale_x_continuous(trans = log_trans(), breaks = trans_breaks("log", function(x) exp(x)),
                         labels = trans_format("log", math_format(e^.x))) +
  scale_y_continuous(trans = log_trans(), breaks = trans_breaks("log", function(x) exp(x)),
                         labels = trans_format("log", math_format(e^.x))) +
  labs(x = "Settlement Population", y = "Weighted Degree Centrality (in and out)",
       title = "Total Degree Centrality on Population: LF SBOM (400-200 BC)",
       subtitle = "Scale Invariant Original Model with Commuters as Population") +
  theme_bw()+
  theme(plot.title=element_text(hjust = 0.5, size=14, face="bold"),
        plot.subtitle = element_text(hjust = 0.5, face="bold", size=12),
        axis.title.x = element_text(color="black", size=12, face="bold"),
        axis.title.y = element_text(color="black", size=12, face="bold"),
        axis.text.y = element_text(color="black", size=12),
        axis.text.x = element_text(color="black", size=12))

##########################################

test$sflines$mn <- test$sflines$m+test$sflines$n
ggplot(data = test$sflines, aes(x = r_ij, y = Tij, color=mn, alpha=mn)) +
  geom_point(size=2) + 
  geom_smooth(method = "gam", formula = y~s(x,k=7), color="darkblue", fill="turquoise1")+
  scale_color_viridis(option = "turbo", begin = 0.60,name=expression('m'[i]+'n'[j]))+
  scale_alpha_continuous(range = c(0.30, 0.9), guide="none")+
  scale_x_continuous(trans = log_trans(), breaks = trans_breaks("log", function(x) exp(x)),
                         labels = trans_format("log", math_format(e^.x))) +
  scale_y_continuous(trans = log_trans(), breaks = trans_breaks("log", function(x) exp(x)),
                         labels = trans_format("log", math_format(e^.x))) +
  labs(x = "Log Transport Network Cost Distance (hrs)", y = "Log Interaction Flow (T_ij)"
       #title = "Interaction Flows on Cost Distance: LF SBOM (400-200 BC)",
       #subtitle = "Scale Invariant Original Model with Commuters as Population"
       ) +
  theme_grey()+
  theme(plot.title=element_text(hjust = 0.5, size=14, face="bold"),
        plot.subtitle = element_text(hjust = 0.5, face="bold", size=12),
        axis.title.x = element_text(color="black", size=12, face="bold"),
        axis.title.y = element_text(color="black", size=12, face="bold"),
        axis.text.y = element_text(color="black", size=12),
        axis.text.x = element_text(color="black", size=12),
        panel.grid.major = element_line(colour = "black"),
        panel.grid.minor = element_line(colour = "grey45"),
        panel.border = element_rect(color = "black", fill = NA),
        panel.background = element_rect(fill = "grey65"),
        legend.justification=c(0.5,0.5), legend.position=c(0.15,0.25), 
        legend.margin = margin(1, 4, 1, 4),
        legend.spacing.y = unit(0.1,"line"),legend.spacing.x = unit(0.55,"line"), 
        legend.text=element_text(size=11),legend.title=element_text(size=16),
        legend.key = element_rect(colour = "transparent", fill = "white"), 
        legend.background = element_rect(colour = 'black', fill = 'white', linetype='solid'))


#############################################



test$sflines$Log_Tij <- log(test$sflines$Tij)
sflines2 <- test$sflines[test$sflines$Log_Tij > 2,]
ggp_map <- ggplot() +  geom_stars(data = Hillshade.s)+
  scale_fill_gradientn(colours = c("turquoise3", "black", "gray60"), 
               values = scales::rescale(c(-9999, -161, 254)), guide="none")+
  geom_sf(data = CatchLims.sf, color="black", size=1, alpha = 0) +
  ggnewscale::new_scale_fill()+
  geom_sf(data = sflines2, mapping=aes(color=Log_Tij, alpha=Log_Tij), size=1) +
  scale_color_viridis(option = "turbo", begin = 0.5, na.value = NA, name = expression('logT'[ij])) +
  scale_alpha_continuous(range = c(0.25, 1), guide="none") +
  #geom_sf(data = Catch.sf, color="black", size=0.3, alpha = 0) +
  
  geom_sf(data=test$sfpts_netstats, mapping=aes(size=Population.s2), shape=21, fill = "darkblue", color="black", stroke = 1, alpha=1)+
  scale_size(range=c(1,6), name="Population")+
  #guides(alpha="none", fill = guide_legend(order = 1, override.aes = list(size = 3,nrow=3)),
  #       size = guide_legend(order = 2, override.aes = list(nrow=4)))+
  #labs(title = "Radiation Model Interaction Flows: Late Formative SBOM (400-200 BC)",
  #     subtitle = "Scale Invariant Original Model with Commuters as Population")+
  coord_sf(datum = sf::st_crs(26914)) +
  xlim(484500,529378)+ylim(2106800,2150500)+
  theme_void() + 
  #labs(x = "Easting", y = "Northing")+
  theme(#legend.position="left", 
        legend.justification=c(0.5,0.5), legend.position=c(0.165,0.32), 
        legend.margin = margin(1, 4, 1, 4),
        legend.spacing.y = unit(0.1,"line"),legend.spacing.x = unit(0.55,"line"), 
        legend.text=element_text(size=11),legend.title=element_text(size=16),
        legend.key = element_rect(colour = "transparent", fill = "white"), 
        legend.background = element_rect(colour = 'black', fill = 'white', linetype='solid')
        #plot.title = element_text(hjust = 0.5, face="bold", size=16),
        #plot.subtitle = element_text(hjust = 0.5, face="bold", size=16)
        )

ggpmap<-ggsave("LF_RadiationMap.png", plot = ggp_map, device = "png", path = wd$figs, scale = 1, width = 5.5, height = 5.5,   units = "in",  dpi = 1000)

sfpts_netstats <- cbind(test$sfpts_netstats,Poly_List[[5]]@data)
x=st_drop_geometry(sfpts_netstats[,c(1,110:115,124,127:128,111:112)])

xx=as.matrix(1-dist(x[,-1],upper=T,method="manhattan"),ncol=ncol(x),nrow=nrow(x))

sflines2=left_join(sflines2, x[,c("AggSite","rPert","Abs_rPert","LogAbs_rPert","rPert0","rPert2")], by=c("from"="AggSite"))
sflines2=left_join(sflines2, x[,c("AggSite","rPert","Abs_rPert","LogAbs_rPert","rPert0","rPert2")], by=c("to"="AggSite"))
sflines2=sflines2 %>% mutate(rPert_sim = scales::rescale(abs(rPert.x - rPert.y),to=c(1,0)),
                        rPert0_sim = scales::rescale(abs(rPert0.x - rPert0.y),to=c(1,0)),
                        rPert2_sim = scales::rescale(abs(rPert2.x - rPert2.y),to=c(1,0)),
                        Abs_rPert_sim = scales::rescale(abs(Abs_rPert.x - Abs_rPert.y), to=c(1,0)),
                        LogAbs_rPert_sim = scales::rescale(abs(Abs_rPert.x - Abs_rPert.y), to=c(1,0)),
                        Pop_sim = scales::rescale(abs(m - n), to=c(1,0))) %>% 
  rowwise() %>% 
  mutate(Avg_Pert_sim = mean(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T),
         Min_Pert_sim = min(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T),
         Max_Pert_sim = max(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T),
         Med_Pert_sim = median(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T),
         sd_Pert_sim = sd(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T)) %>% ungroup()
#3:5,9:12;;;13:22;;;24:34
x=st_drop_geometry(sflines2[,c(3:5,11,13:22)])

pairs.panels(x,
            gap = 0,
            pch=21)

plot(sfpts_netstats["OccuTime"])
```
p + stat_function(fun = LF) + xlim(250,266) +
    scale_y_continuous(trans = log_trans(), 
                         breaks = trans_breaks("log", function(x) exp(x)),
                         labels = trans_format("log", math_format(e^.x)))



```{r}
test = Radiation_EstFlows(df = Poly_List[[9]]@data,
                       var = "Population.s2",
                       d_mat = TrsprtNet_CDmatList[[9]], 
                       xcoords = Poly_List[[9]]@data$East,
                       ycoords = Poly_List[[9]]@data$North,
                       crs_coords = 26914,
                       extended = F, #T
                       alpha = 1.2,
                       scale = "invariant", #c("invariant", "variant", "none")
                       commuters = "var", #c("var", "input", "none")
                       Ti_input = NULL,
                       outputs = c("adjmat", "igraph", "sflines", "sfpts_netstats"))#, "sfnetwork"

ggplot(test$sflines, aes(Tij)) +
  geom_histogram(color = "#000000", fill = "thistle1", bins = 20) +
  labs(x = "Interaction Flows (T_ij)", y = "Frequency",
       title = "Radiation Model Interaction Flows: Classic SBOM (AD 100-550)",
       subtitle = "Scale Invariant Original Model with Commuters as Population") +
  scale_x_continuous(trans = log_trans(), breaks = trans_breaks(n = 10, "log", function(x) exp(x)),
                     labels = label_number(accuracy =0.001))+
  theme_bw()+
  theme(plot.title=element_text(hjust = 0.5, size=14, face="bold"),
        plot.subtitle = element_text(hjust = 0.5, face="bold", size=12),
        axis.title.x = element_text(color="black", size=12, face="bold"),
        axis.title.y = element_text(color="black", size=12, face="bold"),
        axis.text.y = element_text(color="black", size=12),
        axis.text.x = element_text(color="black", size=9, angle=20))

hist(log(test$sfpts_netstats$Rad_centr_indeg))

fit_power_law(test$sfpts_netstats$Rad_centr_indeg)

ggplot(data = test$sfpts_netstats,aes(x = Population.s2, y = Rad_centr_totdeg)) +
  geom_point(size=2) +
  geom_smooth(method = "glm", formula = y~x,method.args = list(family = gaussian()))+
  scale_x_continuous(trans = log_trans(), breaks = trans_breaks("log", function(x) exp(x)),
                         labels = trans_format("log", math_format(e^.x))) +
  scale_y_continuous(trans = log_trans(), breaks = trans_breaks("log", function(x) exp(x)),
                         labels = trans_format("log", math_format(e^.x))) +
  labs(x = "Settlement Population", y = "Weighted Degree Centrality (in and out)",
       title = "Total Degree Centrality on Population: CL SBOM (AD 100-550)",
       subtitle = "Scale Invariant Original Model with Commuters as Population") +
  theme_bw()+
  theme(plot.title=element_text(hjust = 0.5, size=14, face="bold"),
        plot.subtitle = element_text(hjust = 0.5, face="bold", size=12),
        axis.title.x = element_text(color="black", size=12, face="bold"),
        axis.title.y = element_text(color="black", size=12, face="bold"),
        axis.text.y = element_text(color="black", size=12),
        axis.text.x = element_text(color="black", size=12))


test$sflines$mn <- test$sflines$m+test$sflines$n
ggplt <- ggplot(data = test$sflines, aes(x = r_ij, y = Tij, color=mn, alpha=mn)) +
  geom_point(size=2) + 
  geom_smooth(method = "gam", formula = y~s(x,k=7), color="darkblue", fill="turquoise1")+
  scale_color_viridis(option = "turbo", begin = 0.60,name=expression('m'[i]+'n'[j]))+
  scale_alpha_continuous(range = c(0.30, 0.9), guide="none")+
  scale_x_continuous(trans = log_trans(), breaks = trans_breaks("log", function(x) exp(x)),
                         labels = trans_format("log", math_format(e^.x))) +
  scale_y_continuous(trans = log_trans(), breaks = trans_breaks("log", function(x) exp(x)),
                         labels = trans_format("log", math_format(e^.x))) +
  
  labs(x = "Log Transport Network Cost Distance (hrs)", y = "Log Interaction Flow (T_ij)"
       #title = "Interaction Flows on Cost Distance: LF SBOM (400-200 BC)",
       #subtitle = "Scale Invariant Original Model with Commuters as Population"
       ) +
  theme_grey()+
  theme(#plot.title=element_text(hjust = 0.5, size=14, face="bold"),
        plot.margin = margin(1.75, 0.5, 1.25, 0, "in"),
        #plot.subtitle = element_text(hjust = 0.5, face="bold", size=12),
        axis.title.x = element_text(color="black", size=14, face="bold"),
        axis.title.y = element_text(color="black", size=14, face="bold"),
        axis.text.y = element_text(color="black", size=14),
        axis.text.x = element_text(color="black", size=14),
        panel.grid.major = element_line(colour = "black"),
        panel.grid.minor = element_line(colour = "grey45"),
        panel.border = element_rect(color = "black", fill = NA),
        panel.background = element_rect(fill = "grey65"),
        legend.justification=c(0.5,0.5), legend.position=c(0.15,0.25), 
        legend.margin = margin(1, 4, 1, 4),
        legend.spacing.y = unit(0.1,"line"),legend.spacing.x = unit(0.55,"line"), 
        legend.text=element_text(size=13),legend.title=element_text(size=16),
        legend.key = element_rect(colour = "transparent", fill = "white"), 
        legend.background = element_rect(colour = 'black', fill = 'white', linetype='solid'))

ggpmap<-ggsave("CL_RadDistDecayPlot.png", plot = ggplt, device = "png", path = wd$figs, scale = 1, width = 5.5, height = 5,   units = "in",  dpi = 1000)

test$sflines$Log_Tij <- log(test$sflines$Tij)
sflines2 <- test$sflines[test$sflines$Log_Tij > 2,]
ggp_map <- ggplot() +  geom_stars(data = Hillshade.s)+
  scale_fill_gradientn(colours = c("turquoise3", "black", "gray60"), 
               values = scales::rescale(c(-9999, -161, 254)), guide="none")+
  geom_sf(data = CatchLims.sf, color="black", size=1, alpha = 0) +
  ggnewscale::new_scale_fill()+
  geom_sf(data = sflines2, mapping=aes(color=Log_Tij, alpha=Log_Tij), size=1) +
  scale_color_viridis(option = "turbo", begin = 0.6, na.value = NA, name = expression('logT'[ij])) +
  scale_alpha_continuous(range = c(0.25, 1), guide="none") +
  #geom_sf(data = Catch.sf, color="black", size=0.3, alpha = 0) +
  
  geom_sf(data=test$sfpts_netstats, mapping=aes(size=Population.s2), shape=21, fill = "darkblue", color="black", stroke = 1, alpha=1)+
  scale_size(range=c(1,6), name="Population")+
  guides(color = guide_colorbar(order = 1), size = guide_legend(order = 2))+
  #labs(title = "Radiation Model Interaction Flows: Classic Period SBOM (AD 100-550)",
  #     subtitle = "Scale Invariant Original Model with Commuters as Population")+
  coord_sf(datum = sf::st_crs(26914)) +
  xlim(484500,529378)+ylim(2106800,2150500)+
  theme_void() + 
  #labs(x = "Easting", y = "Northing")+
  theme(#legend.position="left", 
        legend.justification=c(0.5,0.5), legend.position=c(0.165,0.34), 
        legend.margin = margin(1, 4, 1, 4),
        plot.margin = margin(0, 0, 0, 0, "in"),#plot.margin = margin(0.2, 0, 0.3, 0.25, "in"),
        legend.spacing.y = unit(0.1,"line"),legend.spacing.x = unit(0.55,"line"), 
        legend.text=element_text(size=11),legend.title=element_text(size=16),
        legend.key = element_rect(colour = "transparent", fill = "white"), 
        legend.background = element_rect(colour = 'black', fill = 'white', linetype='solid')
        #plot.title = element_text(hjust = 0.5, face="bold", size=16),
        #plot.subtitle = element_text(hjust = 0.5, face="bold", size=16)
        )

ggpmap<-ggsave("CL_RadiationMap.png", plot = ggp_map, device = "png", path = wd$figs, scale = 1, width = 5.5, height = 5.5,   units = "in",  dpi = 1000)

plot_row <- plot_grid(ggp_map, ggplt, align = "v", nrow = 1, rel_heights = c(1, 1/2),labels = c('A', 'B'), label_size=40, label_x = c(0.1,0.05), label_y = 0.9)
plot_row
title <- ggdraw() + draw_label("Radiation Model Interaction Flows: Classic Period SBOM (c. AD 100-550)",fontface = 'bold',hjust = 0.5, vjust=0.4, size=20 )

out <- plot_grid(title, plot_row,ncol = 1, rel_heights = c(0.04,1)) + 
          theme(plot.background = element_rect(fill = "white", colour = NA))

ggsave("CL_RadNetMapDistDecay.png", plot = out, device = "png", path = wd$figs, scale = 1, width = 12.5, height = 8.35,   units = "in",  dpi = 1250)



sfpts_netstats <- cbind(test$sfpts_netstats,Poly_List[[9]]@data)
x=st_drop_geometry(sfpts_netstats[,c(1,110:115,124,127:128,111:112)])

xx=as.matrix(1-dist(x[,-1],upper=T,method="manhattan"),ncol=ncol(x),nrow=nrow(x))

sflines2=left_join(sflines2, x[,c("AggSite","rPert","Abs_rPert","LogAbs_rPert","rPert0","rPert2")], by=c("from"="AggSite"))
sflines2=left_join(sflines2, x[,c("AggSite","rPert","Abs_rPert","LogAbs_rPert","rPert0","rPert2")], by=c("to"="AggSite"))
sflines2=sflines2 %>% mutate(rPert_sim = scales::rescale(abs(rPert.x - rPert.y),to=c(1,0)),
                        rPert0_sim = scales::rescale(abs(rPert0.x - rPert0.y),to=c(1,0)),
                        rPert2_sim = scales::rescale(abs(rPert2.x - rPert2.y),to=c(1,0)),
                        Abs_rPert_sim = scales::rescale(abs(Abs_rPert.x - Abs_rPert.y), to=c(1,0)),
                        LogAbs_rPert_sim = scales::rescale(abs(Abs_rPert.x - Abs_rPert.y), to=c(1,0)),
                        Pop_sim = scales::rescale(abs(m - n), to=c(1,0))) %>% 
  rowwise() %>% 
  mutate(Avg_Pert_sim = mean(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T),
         Min_Pert_sim = min(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T),
         Max_Pert_sim = max(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T),
         Med_Pert_sim = median(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T),
         sd_Pert_sim = sd(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T)) %>% ungroup()
#3:5,9:12;;;13:22;;;24:34
x=st_drop_geometry(sflines2[,c(3:5,11,13:22)])

pairs.panels(x,
            gap = 0,
            pch=21)

plot(sfpts_netstats["OccuTime"])
```




```{r}
test = Radiation_EstFlows(df = Poly_List[[13]]@data,
                       var = "Population.s2",
                       d_mat = TrsprtNet_CDmatList[[13]], 
                       xcoords = Poly_List[[13]]@data$East,
                       ycoords = Poly_List[[13]]@data$North,
                       crs_coords = 26914,
                       extended = F, #T
                       alpha = 1.2,
                       scale = "invariant", #c("invariant", "variant", "none")
                       commuters = "var", #c("var", "input", "none")
                       Ti_input = NULL,
                       outputs = c("adjmat", "igraph", "sflines", "sfpts_netstats"))#, "sfnetwork"

ggplot(test$sflines, aes(Tij)) +
  geom_histogram(color = "#000000", fill = "thistle1", bins = 20) +
  labs(x = "Interaction Flows (T_ij)", y = "Frequency",
       title = "Radiation Model Interaction Flows: LT-AzI SBOM (AD 950-1200)",
       subtitle = "Scale Invariant Original Model with Commuters as Population") +
  scale_x_continuous(trans = log_trans(), breaks = trans_breaks(n = 10, "log", function(x) exp(x)),
                     labels = label_number(accuracy =0.001))+
  theme_bw()+
  theme(plot.title=element_text(hjust = 0.5, size=14, face="bold"),
        plot.subtitle = element_text(hjust = 0.5, face="bold", size=12),
        axis.title.x = element_text(color="black", size=12, face="bold"),
        axis.title.y = element_text(color="black", size=12, face="bold"),
        axis.text.y = element_text(color="black", size=12),
        axis.text.x = element_text(color="black", size=9, angle=20))

hist(log(test$sfpts_netstats$Rad_centr_indeg))

fit_power_law(test$sfpts_netstats$Rad_centr_indeg)

ggplot(data = test$sfpts_netstats,aes(x = Population.s2, y = Rad_centr_totdeg)) +
  geom_point(size=2) +
  geom_smooth(method = "glm", formula = y~x,method.args = list(family = gaussian()))+
  scale_x_continuous(trans = log_trans(), breaks = trans_breaks("log", function(x) exp(x)),
                         labels = trans_format("log", math_format(e^.x))) +
  scale_y_continuous(trans = log_trans(), breaks = trans_breaks("log", function(x) exp(x)),
                         labels = trans_format("log", math_format(e^.x))) +
  labs(x = "Settlement Population", y = "Weighted Degree Centrality (in and out)",
       title = "Total Degree Centrality on Population: LT-AzI SBOM (AD 950-1200)",
       subtitle = "Scale Invariant Original Model with Commuters as Population") +
  theme_bw()+
  theme(plot.title=element_text(hjust = 0.5, size=14, face="bold"),
        plot.subtitle = element_text(hjust = 0.5, face="bold", size=12),
        axis.title.x = element_text(color="black", size=12, face="bold"),
        axis.title.y = element_text(color="black", size=12, face="bold"),
        axis.text.y = element_text(color="black", size=12),
        axis.text.x = element_text(color="black", size=12))


ggplot(data = test$sflines,aes(x = r_ij, y = Tij)) +
  geom_point(size=2) +
  geom_smooth(method = "glm", formula = y~x,method.args = list(family = gaussian()))+
  scale_x_continuous(trans = log_trans(), breaks = trans_breaks("log", function(x) exp(x)),
                         labels = trans_format("log", math_format(e^.x))) +
  scale_y_continuous(trans = log_trans(), breaks = trans_breaks("log", function(x) exp(x)),
                         labels = trans_format("log", math_format(e^.x))) +
  labs(x = "Transport Net Cost Distance (hrs)", y = "Interaction Flow (T_ij)",
       title = "Interaction Flows on Cost Distance: LT-AzI SBOM (AD 950-1200)",
       subtitle = "Scale Invariant Original Model with Commuters as Population") +
  theme_bw()+
  theme(plot.title=element_text(hjust = 0.5, size=14, face="bold"),
        plot.subtitle = element_text(hjust = 0.5, face="bold", size=12),
        axis.title.x = element_text(color="black", size=12, face="bold"),
        axis.title.y = element_text(color="black", size=12, face="bold"),
        axis.text.y = element_text(color="black", size=12),
        axis.text.x = element_text(color="black", size=12))

test$sflines$Log_Tij <- log(test$sflines$Tij)
sflines2 <- test$sflines[test$sflines$Log_Tij > 2,]
ggp_map <- ggplot() +  geom_stars(data = Hillshade.s)+
  scale_fill_gradientn(colours = c("turquoise3", "black", "gray60"), 
               values = scales::rescale(c(-9999, -161, 254)), guide="none")+
  geom_sf(data = CatchLims.sf, color="black", size=1, alpha = 0) +
  ggnewscale::new_scale_fill()+
  geom_sf(data = sflines2, mapping=aes(color=Log_Tij, alpha=Log_Tij), size=1) +
  scale_color_viridis(option = "turbo", begin = 0.6, na.value = NA, name = expression('logT'[ij])) +
  scale_alpha_continuous(range = c(0.25, 1), guide="none") +
  #geom_sf(data = Catch.sf, color="black", size=0.3, alpha = 0) +
  
  geom_sf(data=test$sfpts_netstats, mapping=aes(size=Population.s2), shape=21, fill = "darkblue", color="black", stroke = 1, alpha=1)+
  scale_size(range=c(1,6), name="Population")+
  #guides(alpha="none", fill = guide_legend(order = 1, override.aes = list(size = 3,nrow=3)),
  #       size = guide_legend(order = 2, override.aes = list(nrow=4)))+
  #labs(title = "Radiation Model Interaction Flows: Late Formative SBOM (400-200 BC)",
  #     subtitle = "Scale Invariant Original Model with Commuters as Population")+
  coord_sf(datum = sf::st_crs(26914)) +
  xlim(484500,529378)+ylim(2106800,2150500)+
  theme_void() + 
  #labs(x = "Easting", y = "Northing")+
  theme(#legend.position="left", 
        legend.justification=c(0.5,0.5), legend.position=c(0.165,0.32), 
        legend.margin = margin(1, 4, 1, 4),
        legend.spacing.y = unit(0.1,"line"),legend.spacing.x = unit(0.55,"line"), 
        legend.text=element_text(size=11),legend.title=element_text(size=16),
        legend.key = element_rect(colour = "transparent", fill = "white"), 
        legend.background = element_rect(colour = 'black', fill = 'white', linetype='solid')
        #plot.title = element_text(hjust = 0.5, face="bold", size=16),
        #plot.subtitle = element_text(hjust = 0.5, face="bold", size=16)
        )

ggpmap<-ggsave("LTAzI_RadiationMap.png", plot = ggp_map, device = "png", path = wd$figs, scale = 1, width = 5.5, height = 5.5,   units = "in",  dpi = 1000)

sfpts_netstats <- cbind(test$sfpts_netstats,Poly_List[[13]]@data)
x=st_drop_geometry(sfpts_netstats[,c(1,110:115,124,127:128,111:112)])

xx=as.matrix(1-dist(x[,-1],upper=T,method="manhattan"),ncol=ncol(x),nrow=nrow(x))

sflines2=left_join(sflines2, x[,c("AggSite","rPert","Abs_rPert","LogAbs_rPert","rPert0","rPert2")], by=c("from"="AggSite"))
sflines2=left_join(sflines2, x[,c("AggSite","rPert","Abs_rPert","LogAbs_rPert","rPert0","rPert2")], by=c("to"="AggSite"))
sflines2=sflines2 %>% mutate(rPert_sim = scales::rescale(abs(rPert.x - rPert.y),to=c(1,0)),
                        rPert0_sim = scales::rescale(abs(rPert0.x - rPert0.y),to=c(1,0)),
                        rPert2_sim = scales::rescale(abs(rPert2.x - rPert2.y),to=c(1,0)),
                        Abs_rPert_sim = scales::rescale(abs(Abs_rPert.x - Abs_rPert.y), to=c(1,0)),
                        LogAbs_rPert_sim = scales::rescale(abs(Abs_rPert.x - Abs_rPert.y), to=c(1,0)),
                        Pop_sim = scales::rescale(abs(m - n), to=c(1,0))) %>% 
  rowwise() %>% 
  mutate(Avg_Pert_sim = mean(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T),
         Min_Pert_sim = min(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T),
         Max_Pert_sim = max(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T),
         Med_Pert_sim = median(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T),
         sd_Pert_sim = sd(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T)) %>% ungroup()
#3:5,9:12;;;13:22;;;24:34
x=st_drop_geometry(sflines2[,c(3:5,11,13:22)])

pairs.panels(x,
            gap = 0,
            pch=21)

plot(sfpts_netstats["OccuTime"])
```

```{r}
test = Radiation_EstFlows(df = Poly_List[[11]]@data,
                       var = "Population.s2",
                       d_mat = TrsprtNet_CDmatList[[11]], 
                       xcoords = Poly_List[[11]]@data$East,
                       ycoords = Poly_List[[11]]@data$North,
                       crs_coords = 26914,
                       extended = F, #T
                       alpha = 1.2,
                       scale = "invariant", #c("invariant", "variant", "none")
                       commuters = "var", #c("var", "input", "none")
                       Ti_input = NULL,
                       outputs = c("adjmat", "igraph", "sflines", "sfpts_netstats"))#, "sfnetwork"

ggplot(test$sflines, aes(Tij)) +
  geom_histogram(color = "#000000", fill = "thistle1", bins = 20) +
  labs(x = "Interaction Flows (T_ij)", y = "Frequency",
       title = "Radiation Model Interaction Flows: ET SBOM (AD 650-850)",
       subtitle = "Scale Invariant Original Model with Commuters as Population") +
  scale_x_continuous(trans = log_trans(), breaks = trans_breaks(n = 10, "log", function(x) exp(x)),
                     labels = label_number(accuracy =0.001))+
  theme_bw()+
  theme(plot.title=element_text(hjust = 0.5, size=14, face="bold"),
        plot.subtitle = element_text(hjust = 0.5, face="bold", size=12),
        axis.title.x = element_text(color="black", size=12, face="bold"),
        axis.title.y = element_text(color="black", size=12, face="bold"),
        axis.text.y = element_text(color="black", size=12),
        axis.text.x = element_text(color="black", size=9, angle=20))

hist(log(test$sfpts_netstats$Rad_centr_indeg))

fit_power_law(test$sfpts_netstats$Rad_centr_indeg)

ggplot(data = test$sfpts_netstats,aes(x = Population.s2, y = Rad_centr_totdeg)) +
  geom_point(size=2) +
  geom_smooth(method = "glm", formula = y~x,method.args = list(family = gaussian()))+
  scale_x_continuous(trans = log_trans(), breaks = trans_breaks("log", function(x) exp(x)),
                         labels = trans_format("log", math_format(e^.x))) +
  scale_y_continuous(trans = log_trans(), breaks = trans_breaks("log", function(x) exp(x)),
                         labels = trans_format("log", math_format(e^.x))) +
  labs(x = "Settlement Population", y = "Weighted Degree Centrality (in and out)",
       title = "Total Degree Centrality on Population: ET SBOM (AD 650-850)",
       subtitle = "Scale Invariant Original Model with Commuters as Population") +
  theme_bw()+
  theme(plot.title=element_text(hjust = 0.5, size=14, face="bold"),
        plot.subtitle = element_text(hjust = 0.5, face="bold", size=12),
        axis.title.x = element_text(color="black", size=12, face="bold"),
        axis.title.y = element_text(color="black", size=12, face="bold"),
        axis.text.y = element_text(color="black", size=12),
        axis.text.x = element_text(color="black", size=12))


ggplot(data = test$sflines,aes(x = r_ij, y = Tij)) +
  geom_point(size=2) +
  geom_smooth(method = "glm", formula = y~x,method.args = list(family = gaussian()))+
  scale_x_continuous(trans = log_trans(), breaks = trans_breaks("log", function(x) exp(x)),
                         labels = trans_format("log", math_format(e^.x))) +
  scale_y_continuous(trans = log_trans(), breaks = trans_breaks("log", function(x) exp(x)),
                         labels = trans_format("log", math_format(e^.x))) +
  labs(x = "Transport Net Cost Distance (hrs)", y = "Interaction Flow (T_ij)",
       title = "Interaction Flows on Cost Distance: ET SBOM (AD 650-850)",
       subtitle = "Scale Invariant Original Model with Commuters as Population") +
  theme_bw()+
  theme(plot.title=element_text(hjust = 0.5, size=14, face="bold"),
        plot.subtitle = element_text(hjust = 0.5, face="bold", size=12),
        axis.title.x = element_text(color="black", size=12, face="bold"),
        axis.title.y = element_text(color="black", size=12, face="bold"),
        axis.text.y = element_text(color="black", size=12),
        axis.text.x = element_text(color="black", size=12))

test$sflines$Log_Tij <- log(test$sflines$Tij)
sflines2 <- test$sflines[test$sflines$Log_Tij > 2,]
ggp_map <- ggplot() +  geom_stars(data = Hillshade.s)+
  scale_fill_gradientn(colours = c("turquoise3", "black", "gray60"), 
               values = scales::rescale(c(-9999, -161, 254)), guide="none")+
  geom_sf(data = CatchLims.sf, color="black", size=1, alpha = 0) +
  ggnewscale::new_scale_fill()+
  geom_sf(data = sflines2, mapping=aes(color=Log_Tij, alpha=Log_Tij), size=1) +
  scale_color_viridis(option = "turbo", begin = 0.6, na.value = NA, name = expression('logT'[ij])) +
  scale_alpha_continuous(range = c(0.25, 1), guide="none") +
  #geom_sf(data = Catch.sf, color="black", size=0.3, alpha = 0) +
  
  geom_sf(data=test$sfpts_netstats, mapping=aes(size=Population.s2), shape=21, fill = "darkblue", color="black", stroke = 1, alpha=1)+
  scale_size(range=c(1,6), name="Population")+
  #guides(alpha="none", fill = guide_legend(order = 1, override.aes = list(size = 3,nrow=3)),
  #       size = guide_legend(order = 2, override.aes = list(nrow=4)))+
  #labs(title = "Radiation Model Interaction Flows: Late Formative SBOM (400-200 BC)",
  #     subtitle = "Scale Invariant Original Model with Commuters as Population")+
  coord_sf(datum = sf::st_crs(26914)) +
  xlim(484500,529378)+ylim(2106800,2150500)+
  theme_void() + 
  #labs(x = "Easting", y = "Northing")+
  theme(#legend.position="left", 
        legend.justification=c(0.5,0.5), legend.position=c(0.165,0.32), 
        legend.margin = margin(1, 4, 1, 4),
        legend.spacing.y = unit(0.1,"line"),legend.spacing.x = unit(0.55,"line"), 
        legend.text=element_text(size=11),legend.title=element_text(size=16),
        legend.key = element_rect(colour = "transparent", fill = "white"), 
        legend.background = element_rect(colour = 'black', fill = 'white', linetype='solid')
        #plot.title = element_text(hjust = 0.5, face="bold", size=16),
        #plot.subtitle = element_text(hjust = 0.5, face="bold", size=16)
        )

ggpmap<-ggsave("ET_RadiationMap.png", plot = ggp_map, device = "png", path = wd$figs, scale = 1, width = 5.5, height = 5.5,   units = "in",  dpi = 1000)

sfpts_netstats <- cbind(test$sfpts_netstats,Poly_List[[11]]@data)
x=st_drop_geometry(sfpts_netstats[,c(1,110:115,124,127:128,111:112)])

xx=as.matrix(1-dist(x[,-1],upper=T,method="manhattan"),ncol=ncol(x),nrow=nrow(x))

sflines2=left_join(sflines2, x[,c("AggSite","rPert","Abs_rPert","LogAbs_rPert","rPert0","rPert2")], by=c("from"="AggSite"))
sflines2=left_join(sflines2, x[,c("AggSite","rPert","Abs_rPert","LogAbs_rPert","rPert0","rPert2")], by=c("to"="AggSite"))
sflines2=sflines2 %>% mutate(rPert_sim = scales::rescale(abs(rPert.x - rPert.y),to=c(1,0)),
                        rPert0_sim = scales::rescale(abs(rPert0.x - rPert0.y),to=c(1,0)),
                        rPert2_sim = scales::rescale(abs(rPert2.x - rPert2.y),to=c(1,0)),
                        Abs_rPert_sim = scales::rescale(abs(Abs_rPert.x - Abs_rPert.y), to=c(1,0)),
                        LogAbs_rPert_sim = scales::rescale(abs(Abs_rPert.x - Abs_rPert.y), to=c(1,0)),
                        Pop_sim = scales::rescale(abs(m - n), to=c(1,0))) %>% 
  rowwise() %>% 
  mutate(Avg_Pert_sim = mean(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T),
         Min_Pert_sim = min(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T),
         Max_Pert_sim = max(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T),
         Med_Pert_sim = median(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T),
         sd_Pert_sim = sd(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T)) %>% ungroup()
#3:5,9:12;;;13:22;;;24:34
x=st_drop_geometry(sflines2[,c(3:5,11,13:22)])

pairs.panels(x,
            gap = 0,
            pch=21)

plot(sfpts_netstats["OccuTime"])
```


```{r}
test = Radiation_EstFlows(df = Poly_List[[16]]@data,
                       var = "Population.s2",
                       d_mat = TrsprtNet_CDmatList[[16]], 
                       xcoords = Poly_List[[16]]@data$East,
                       ycoords = Poly_List[[16]]@data$North,
                       crs_coords = 26914,
                       extended = T, #T
                       alpha = 0.5,
                       scale = "invariant", #c("invariant", "variant", "none")
                       commuters = "var", #c("var", "input", "none")
                       Ti_input = NULL,
                       outputs = c("adjmat", "igraph", "sflines", "sfpts_netstats"))#, "sfnetwork"

ggplot(test$sflines, aes(Tij)) +
  geom_histogram(color = "#000000", fill = "thistle1", bins = 20) +
  labs(x = "Interaction Flows (T_ij)", y = "Frequency",
       title = "Radiation Model Interaction Flows: EA_LA SBOM (AD 1350-1475)",
       subtitle = "Scale Invariant Original Model with Commuters as Population") +
  scale_x_continuous(trans = log_trans(), breaks = trans_breaks(n = 10, "log", function(x) exp(x)),
                     labels = label_number(accuracy =0.001))+
  theme_bw()+
  theme(plot.title=element_text(hjust = 0.5, size=14, face="bold"),
        plot.subtitle = element_text(hjust = 0.5, face="bold", size=12),
        axis.title.x = element_text(color="black", size=12, face="bold"),
        axis.title.y = element_text(color="black", size=12, face="bold"),
        axis.text.y = element_text(color="black", size=12),
        axis.text.x = element_text(color="black", size=9, angle=20))

hist(log(test$sfpts_netstats$Rad_centr_indeg))

fit_power_law(test$sfpts_netstats$Rad_centr_indeg)

ggplot(data = test$sfpts_netstats,aes(x = Population.s2, y = Rad_centr_totdeg)) +
  geom_point(size=2) +
  geom_smooth(method = "glm", formula = y~x,method.args = list(family = gaussian()))+
  scale_x_continuous(trans = log_trans(), breaks = trans_breaks("log", function(x) exp(x)),
                         labels = trans_format("log", math_format(e^.x))) +
  scale_y_continuous(trans = log_trans(), breaks = trans_breaks("log", function(x) exp(x)),
                         labels = trans_format("log", math_format(e^.x))) +
  labs(x = "Settlement Population", y = "Weighted Degree Centrality (in and out)",
       title = "Total Degree Centrality on Population: EA_LA SBOM (AD 1350-1475)",
       subtitle = "Scale Invariant Original Model with Commuters as Population") +
  theme_bw()+
  theme(plot.title=element_text(hjust = 0.5, size=14, face="bold"),
        plot.subtitle = element_text(hjust = 0.5, face="bold", size=12),
        axis.title.x = element_text(color="black", size=12, face="bold"),
        axis.title.y = element_text(color="black", size=12, face="bold"),
        axis.text.y = element_text(color="black", size=12),
        axis.text.x = element_text(color="black", size=12))


ggplot(data = test$sflines,aes(x = r_ij, y = Tij)) +
  geom_point(size=2) +
  geom_smooth(method = "glm", formula = y~x,method.args = list(family = gaussian()))+
  scale_x_continuous(trans = log_trans(), breaks = trans_breaks("log", function(x) exp(x)),
                         labels = trans_format("log", math_format(e^.x))) +
  scale_y_continuous(trans = log_trans(), breaks = trans_breaks("log", function(x) exp(x)),
                         labels = trans_format("log", math_format(e^.x))) +
  labs(x = "Transport Net Cost Distance (hrs)", y = "Interaction Flow (T_ij)",
       title = "Interaction Flows on Cost Distance: EA_LA SBOM (AD 1350-1475)",
       subtitle = "Scale Invariant Original Model with Commuters as Population") +
  theme_bw()+
  theme(plot.title=element_text(hjust = 0.5, size=14, face="bold"),
        plot.subtitle = element_text(hjust = 0.5, face="bold", size=12),
        axis.title.x = element_text(color="black", size=12, face="bold"),
        axis.title.y = element_text(color="black", size=12, face="bold"),
        axis.text.y = element_text(color="black", size=12),
        axis.text.x = element_text(color="black", size=12))


test$sflines$Log_Tij <- log(test$sflines$Tij)
sflines2 <- test$sflines[test$sflines$Log_Tij > 2,]
ggp_map <- ggplot() +  geom_stars(data = Hillshade.s)+
  scale_fill_gradientn(colours = c("turquoise3", "black", "gray60"), 
               values = scales::rescale(c(-9999, -161, 254)), guide="none")+
  geom_sf(data = CatchLims.sf, color="black", size=1, alpha = 0) +
  ggnewscale::new_scale_fill()+
  geom_sf(data = sflines2, mapping=aes(color=Log_Tij, alpha=Log_Tij), size=1) +
  scale_color_viridis(option = "turbo", begin = 0.6, na.value = NA, name = expression('logT'[ij])) +
  scale_alpha_continuous(range = c(0.25, 1), guide="none") +
  #geom_sf(data = Catch.sf, color="black", size=0.3, alpha = 0) +
  
  geom_sf(data=test$sfpts_netstats, mapping=aes(size=Population.s2), shape=21, fill = "darkblue", color="black", stroke = 1, alpha=1)+
  scale_size(range=c(1,6), name="Population")+
  #guides(alpha="none", fill = guide_legend(order = 1, override.aes = list(size = 3,nrow=3)),
  #       size = guide_legend(order = 2, override.aes = list(nrow=4)))+
  #labs(title = "Radiation Model Interaction Flows: Late Formative SBOM (400-200 BC)",
  #     subtitle = "Scale Invariant Original Model with Commuters as Population")+
  coord_sf(datum = sf::st_crs(26914)) +
  xlim(484500,529378)+ylim(2106800,2150500)+
  theme_void() + 
  #labs(x = "Easting", y = "Northing")+
  theme(#legend.position="left", 
        legend.justification=c(0.5,0.5), legend.position=c(0.165,0.32), 
        legend.margin = margin(1, 4, 1, 4),
        legend.spacing.y = unit(0.1,"line"),legend.spacing.x = unit(0.55,"line"), 
        legend.text=element_text(size=11),legend.title=element_text(size=16),
        legend.key = element_rect(colour = "transparent", fill = "white"), 
        legend.background = element_rect(colour = 'black', fill = 'white', linetype='solid')
        #plot.title = element_text(hjust = 0.5, face="bold", size=16),
        #plot.subtitle = element_text(hjust = 0.5, face="bold", size=16)
        )

ggpmap<-ggsave("EA_LA_RadiationMap.png", plot = ggp_map, device = "png", path = wd$figs, scale = 1, width = 5.5, height = 5.5,   units = "in",  dpi = 1000)

sfpts_netstats <- cbind(test$sfpts_netstats,Poly_List[[16]]@data)
x=st_drop_geometry(sfpts_netstats[,c(1,110:115,124,127:128,111:112)])

xx=as.matrix(1-dist(x[,-1],upper=T,method="manhattan"),ncol=ncol(x),nrow=nrow(x))

sflines2=left_join(sflines2, x[,c("AggSite","rPert","Abs_rPert","LogAbs_rPert","rPert0","rPert2")], by=c("from"="AggSite"))
sflines2=left_join(sflines2, x[,c("AggSite","rPert","Abs_rPert","LogAbs_rPert","rPert0","rPert2")], by=c("to"="AggSite"))
sflines2=sflines2 %>% mutate(rPert_sim = scales::rescale(abs(rPert.x - rPert.y),to=c(1,0)),
                        rPert0_sim = scales::rescale(abs(rPert0.x - rPert0.y),to=c(1,0)),
                        rPert2_sim = scales::rescale(abs(rPert2.x - rPert2.y),to=c(1,0)),
                        Abs_rPert_sim = scales::rescale(abs(Abs_rPert.x - Abs_rPert.y), to=c(1,0)),
                        LogAbs_rPert_sim = scales::rescale(abs(Abs_rPert.x - Abs_rPert.y), to=c(1,0)),
                        Pop_sim = scales::rescale(abs(m - n), to=c(1,0))) %>% 
  rowwise() %>% 
  mutate(Avg_Pert_sim = mean(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T),
         Min_Pert_sim = min(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T),
         Max_Pert_sim = max(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T),
         Med_Pert_sim = median(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T),
         sd_Pert_sim = sd(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T)) %>% ungroup()
#3:5,9:12;;;13:22;;;24:34
x=st_drop_geometry(sflines2[,c(3:5,11,13:22)])

pairs.panels(x,
            gap = 0,
            pch=21)

plot(sfpts_netstats["OccuTime"])
```









```{r}
test = Radiation_EstFlows(df = Poly_List[[12]]@data,
                       var = "Population.s2",
                       d_mat = TrsprtNet_CDmatList[[12]], 
                       xcoords = Poly_List[[12]]@data$East,
                       ycoords = Poly_List[[12]]@data$North,
                       crs_coords = 26914,
                       extended = F, #T
                       alpha = 0.5,
                       scale = "invariant", #c("invariant", "variant", "none")
                       commuters = "var", #c("var", "input", "none")
                       Ti_input = NULL,
                       outputs = c("adjmat", "igraph", "sflines", "sfpts_netstats"))#, "sfnetwork"

ggplot(test$sflines, aes(Tij)) +
  geom_histogram(color = "#000000", fill = "thistle1", bins = 20) +
  labs(x = "Interaction Flows (T_ij)", y = "Frequency",
       title = "Radiation Model Interaction Flows: ET LTAzI SBOM (AD 850-950)",
       subtitle = "Scale Invariant Original Model with Commuters as Population") +
  scale_x_continuous(trans = log_trans(), breaks = trans_breaks(n = 10, "log", function(x) exp(x)),
                     labels = label_number(accuracy =0.001))+
  theme_bw()+
  theme(plot.title=element_text(hjust = 0.5, size=14, face="bold"),
        plot.subtitle = element_text(hjust = 0.5, face="bold", size=12),
        axis.title.x = element_text(color="black", size=12, face="bold"),
        axis.title.y = element_text(color="black", size=12, face="bold"),
        axis.text.y = element_text(color="black", size=12),
        axis.text.x = element_text(color="black", size=9, angle=20))

hist(log(test$sfpts_netstats$Rad_centr_indeg))

fit_power_law(test$sfpts_netstats$Rad_centr_indeg)

ggplot(data = test$sfpts_netstats,aes(x = Population.s2, y = Rad_centr_totdeg)) +
  geom_point(size=2) +
  geom_smooth(method = "glm", formula = y~x,method.args = list(family = gaussian()))+
  scale_x_continuous(trans = log_trans(), breaks = trans_breaks("log", function(x) exp(x)),
                         labels = trans_format("log", math_format(e^.x))) +
  scale_y_continuous(trans = log_trans(), breaks = trans_breaks("log", function(x) exp(x)),
                         labels = trans_format("log", math_format(e^.x))) +
  labs(x = "Settlement Population", y = "Weighted Degree Centrality (in and out)",
       title = "Total Degree Centrality on Population: ET LTAzI SBOM (AD 850-950)",
       subtitle = "Scale Invariant Original Model with Commuters as Population") +
  theme_bw()+
  theme(plot.title=element_text(hjust = 0.5, size=14, face="bold"),
        plot.subtitle = element_text(hjust = 0.5, face="bold", size=12),
        axis.title.x = element_text(color="black", size=12, face="bold"),
        axis.title.y = element_text(color="black", size=12, face="bold"),
        axis.text.y = element_text(color="black", size=12),
        axis.text.x = element_text(color="black", size=12))

###########################
ggplot(data = test$sflines,aes(x = r_ij, y = Tij)) +
  geom_point(size=2) +
  geom_smooth(method = "glm", formula = y~ exp(x) + exp(m) + exp(n),method.args = list(family = poisson()), 
              color="blue", fill="deepskyblue", size=1.3)+
  geom_smooth(method = "gam", formula = y ~ s(x), color="red2", fill="salmon", 
              size=1, linetype = "twodash", alpha=0.4)+
  scale_x_continuous(trans = log_trans(), breaks = trans_breaks("log", function(x) exp(x)),
                         labels = trans_format("log", math_format(e^.x))) +
  scale_y_continuous(trans = log_trans(), breaks = trans_breaks("log", function(x) exp(x)),
                         labels = trans_format("log", math_format(e^.x))) +
  labs(x = "Log Transport Network Cost Distance (hrs)", y = "Log Interaction Flow (T_ij)",
       title = "Interaction Flows on Cost Distance: ET LTAzI SBOM (AD 850-950)",
       subtitle = "Scale Invariant Original Model with Commuters as Population") +
  theme_bw()+
  theme(plot.title=element_text(hjust = 0.5, size=14, face="bold"),
        plot.subtitle = element_text(hjust = 0.5, face="bold", size=12),
        axis.title.x = element_text(color="black", size=12, face="bold"),
        axis.title.y = element_text(color="black", size=12, face="bold"),
        axis.text.y = element_text(color="black", size=12),
        axis.text.x = element_text(color="black", size=12))
######################################

test$sflines$Log_Tij <- log(test$sflines$Tij)
sflines2 <- test$sflines[test$sflines$Log_Tij > 2,]
ggp_map <- ggplot() +  geom_stars(data = Hillshade.s)+
  scale_fill_gradientn(colours = c("turquoise3", "black", "gray60"), 
               values = scales::rescale(c(-9999, -161, 254)), guide="none")+
  geom_sf(data = CatchLims.sf, color="black", size=1, alpha = 0) +
  ggnewscale::new_scale_fill()+
  geom_sf(data = sflines2, mapping=aes(color=Log_Tij, alpha=Log_Tij), size=1) +
  scale_color_viridis(option = "turbo", begin = 0.6, na.value = NA, name = expression('logT'[ij])) +
  scale_alpha_continuous(range = c(0.25, 1), guide="none") +
  #geom_sf(data = Catch.sf, color="black", size=0.3, alpha = 0) +
  
  geom_sf(data=test$sfpts_netstats, mapping=aes(size=Population.s2), shape=21, fill = "darkblue", color="black", stroke = 1, alpha=1)+
  scale_size(range=c(1,6), name="Population")+
  #guides(alpha="none", fill = guide_legend(order = 1, override.aes = list(size = 3,nrow=3)),
  #       size = guide_legend(order = 2, override.aes = list(nrow=4)))+
  #labs(title = "Radiation Model Interaction Flows: Late Formative SBOM (400-200 BC)",
  #     subtitle = "Scale Invariant Original Model with Commuters as Population")+
  coord_sf(datum = sf::st_crs(26914)) +
  xlim(484500,529378)+ylim(2106800,2150500)+
  theme_void() + 
  #labs(x = "Easting", y = "Northing")+
  theme(#legend.position="left", 
        legend.justification=c(0.5,0.5), legend.position=c(0.165,0.32), 
        legend.margin = margin(1, 4, 1, 4),
        legend.spacing.y = unit(0.1,"line"),legend.spacing.x = unit(0.55,"line"), 
        legend.text=element_text(size=11),legend.title=element_text(size=16),
        legend.key = element_rect(colour = "transparent", fill = "white"), 
        legend.background = element_rect(colour = 'black', fill = 'white', linetype='solid')
        #plot.title = element_text(hjust = 0.5, face="bold", size=16),
        #plot.subtitle = element_text(hjust = 0.5, face="bold", size=16)
        )

ggpmap<-ggsave("ET_LTAzI_RadiationMap.png", plot = ggp_map, device = "png", path = wd$figs, scale = 1, width = 5.5, height = 5.5,   units = "in",  dpi = 1000)

sfpts_netstats <- cbind(test$sfpts_netstats,Poly_List[[12]]@data)
x=st_drop_geometry(sfpts_netstats[,c(1,110:115,124,127:128,111:112)])

xx=as.matrix(1-dist(x[,-1],upper=T,method="manhattan"),ncol=ncol(x),nrow=nrow(x))

sflines2=left_join(sflines2, x[,c("AggSite","rPert","Abs_rPert","LogAbs_rPert","rPert0","rPert2")], by=c("from"="AggSite"))
sflines2=left_join(sflines2, x[,c("AggSite","rPert","Abs_rPert","LogAbs_rPert","rPert0","rPert2")], by=c("to"="AggSite"))
sflines2=sflines2 %>% mutate(rPert_sim = scales::rescale(abs(rPert.x - rPert.y),to=c(1,0)),
                        rPert0_sim = scales::rescale(abs(rPert0.x - rPert0.y),to=c(1,0)),
                        rPert2_sim = scales::rescale(abs(rPert2.x - rPert2.y),to=c(1,0)),
                        Abs_rPert_sim = scales::rescale(abs(Abs_rPert.x - Abs_rPert.y), to=c(1,0)),
                        LogAbs_rPert_sim = scales::rescale(abs(Abs_rPert.x - Abs_rPert.y), to=c(1,0)),
                        Pop_sim = scales::rescale(abs(m - n), to=c(1,0))) %>% 
  rowwise() %>% 
  mutate(Avg_Pert_sim = mean(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T),
         Min_Pert_sim = min(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T),
         Max_Pert_sim = max(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T),
         Med_Pert_sim = median(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T),
         sd_Pert_sim = sd(c(rPert_sim, rPert0_sim, rPert2_sim, Abs_rPert_sim, LogAbs_rPert_sim), na.rm=T)) %>% ungroup()
#3:5,9:12;;;13:22;;;24:34
x=st_drop_geometry(sflines2[,c(3:5,11,13:22)])

pairs.panels(x,
            gap = 0,
            pch=21)

plot(sfpts_netstats["OccuTime"])
```













































```{r}
test = Radiation_EstFlows(df = Poly_List[[5]]@data,
                       var = "Population.s2",
                       d_mat = CD.mats[[5]], 
                       xcoords = Poly_List[[5]]@data$East,
                       ycoords = Poly_List[[5]]@data$North,
                       crs_coords = 26914,
                       extended = F, #T
                       alpha = 1.2,
                       scale = "none", #c("invariant", "variant", "none")
                       commuters = "none", #c("var", "input", "none")
                       Ti_input = NULL,
                       outputs = c("adjmat", "sflines", "sfpts_netstats"))#, "sfnetwork"

ggplot(test$sflines, aes(Tij)) +
  geom_histogram(color = "#000000", fill = "lightgreen", bins = 20) +
  labs(x = "Interaction Flows (T_ij)", y = "Frequency",
       title = "Radiation Model Interaction Flows: Late Formative SBOM (400-200 BC)",
       subtitle = "Scale Invariant Original Model Conditional Probabilities") +
  scale_x_continuous(trans = log_trans(), breaks = trans_breaks(n = 10, "log", function(x) exp(x)),
                     labels = label_number(accuracy =0.001))+
  theme_bw()+
  theme(plot.title=element_text(hjust = 0.5, size=14, face="bold"),
        plot.subtitle = element_text(hjust = 0.5, face="bold", size=12),
        axis.title.x = element_text(color="black", size=12, face="bold"),
        axis.title.y = element_text(color="black", size=12, face="bold"),
        axis.text.y = element_text(color="black", size=12),
        axis.text.x = element_text(color="black", size=9, angle=20))


```


```{r}
test = Radiation_EstFlows(df = Poly_List[[5]]@data,
                       var = "Population.s2",
                       d_mat = CD.mats[[5]], 
                       xcoords = Poly_List[[5]]@data$East,
                       ycoords = Poly_List[[5]]@data$North,
                       crs_coords = 26914,
                       extended = T, #T
                       alpha = 0.2,
                       scale = "variant", #c("invariant", "variant", "none")
                       commuters = "var", #c("var", "input", "none")
                       Ti_input = NULL,
                       outputs = c("adjmat", "sflines", "sfpts_netstats"))#, "sfnetwork"


ggplot(test$sflines, aes(Tij)) +
  geom_histogram(color = "#000000", fill = "khaki1", bins = 20) +
  labs(x = "Interaction Flows (T_ij)", y = "Frequency",
       title = "Radiation Model Interaction Flows: Late Formative SBOM (400-200 BC)",
       subtitle = "Scale Variant Extended Model with Commuters as Population & alpha=0.2") +
  scale_x_continuous(trans = log_trans(), breaks = trans_breaks(n = 10, "log", function(x) exp(x)),
                     labels = label_number(accuracy =0.001))+
  theme_bw()+
  theme(plot.title=element_text(hjust = 0.5, size=14, face="bold"),
        plot.subtitle = element_text(hjust = 0.5, face="bold", size=12),
        axis.title.x = element_text(color="black", size=12, face="bold"),
        axis.title.y = element_text(color="black", size=12, face="bold"),
        axis.text.y = element_text(color="black", size=12),
        axis.text.x = element_text(color="black", size=9, angle=20))


```
p + stat_function(fun = LF) + xlim(250,266) +
    scale_y_continuous(trans = log_trans(), 
                         breaks = trans_breaks("log", function(x) exp(x)),
                         labels = trans_format("log", math_format(e^.x)))

of the number of job opportunities between the source and the destination on the job selection


-\frac{m_i}{M}

### Dimensional Proxies for "Total Commuters" T_i

```{r, 'Proxies for Radiation Model T_i', message=FALSE, warning=FALSE}

```


## Rihll-Wilson Retail Model

```{r}

```




# Recombining and Reorganizing the Data

```{r, 'Recombining the Data', message=FALSE, warning=FALSE}
# Convert lists of period-wise sites/catchments to single SPDF objects
All_Agg_SitePoly <-  do.call(rbind, Poly_List)
All_Agg_CatchPoly <- do.call(rbind, Catch_List)

# variables from site data that needs transfer over to catchment areas
colz1 = setdiff(colnames(All_Agg_SitePoly@data),colnames(All_Agg_CatchPoly@data))
# variables from catchment areas that needs transfer over to site data
colz2 = setdiff(colnames(All_Agg_CatchPoly@data),colnames(All_Agg_SitePoly@data))

#reorder the data to match
All_Agg_SitePoly <- All_Agg_SitePoly[order(All_Agg_SitePoly$AggSite),]
All_Agg_CatchPoly <- All_Agg_CatchPoly[order(All_Agg_CatchPoly$AggSite),]

#check to see that the two datasets are in the right order
#identical(All_Agg_SitePoly@data$AggSite, All_Agg_CatchPoly@data$AggSite)

# Site data to catchment areas
Site_to_Catch <- All_Agg_SitePoly@data %>% select(!!!syms(colz1))
All_Agg_CatchPoly@data <- cbind(All_Agg_CatchPoly@data,Site_to_Catch)

# catchment area data to sites
Catch_to_Site <- All_Agg_CatchPoly@data %>% select(!!!syms(colz2))
All_Agg_SitePoly@data <- cbind(All_Agg_SitePoly@data,Catch_to_Site)

#Reorganize the data

ordering <- c(
  #ID VARIABLES
      "AggSite","AggID","Site","East","North","SurvReg","Number","CerPhase","Period", 
      "PeriodType","PeriodLength","PeriodNum","PeriodBegin","PeriodEnd", 
      "OccSeqLoc","OccSeqLoc.Sites","SubOccSeqLoc","SubOccSeqLoc.Sites",
      "ComponentNum", "ComponentSites",
  #CHRONOLOGICAL VARIABLES
      "PeriodInterval", "PeriodBegin", "PeriodBegin.era", "PeriodMidpoint", 
      "PeriodMidpoint.era", "PeriodEnd", "PeriodEnd.era", "PeriodLength",
  #OCCUPATION VARIABLES (COUNTS)
      "Occ.EF","Occ.EF_MF","Occ.MF","Occ.MF_LF","Occ.LF","Occ.LF_TF",
      "Occ.TF","Occ.TF_CL","Occ.CL","Occ.CL_ET","Occ.ET","Occ.ET_LTAzI", 
      "Occ.LTAzI","Occ.LTAzI_EA","Occ.EA","Occ.EA_LA","Occ.LA","Occ.TOT",
  #SUBOCCUPATION VARIABLES (COUNTS)
      "SubOcc.EF","SubOcc.EF_MF","SubOcc.MF","SubOcc.MF_LF","SubOcc.LF",
      "SubOcc.LF_TF","SubOcc.TF","SubOcc.TF_CL","SubOcc.CL","SubOcc.CL_ET",
      "SubOcc.ET","SubOcc.ET_LTAzI","SubOcc.LTAzI","SubOcc.LTAzI_EA",
      "SubOcc.EA","SubOcc.EA_LA","SubOcc.LA","SubOcc.TOT",
  #SITE AREA AND OCCUPATIONAL DENSITY VARS
      "Area_ha","Perim_m2","SherdDens","Tot.Assemb","FwOvlp.Assemb", 
      "BwOvlp.Assemb", "Net.Assemb",
  #STEP #2 DEMOGRAPHIC VARIABLES
      "Population.s2","Log_Population.s2", "ApportAssemb", "PopDens.s2",
      "UrbanScale.s2", "UrbanPop.s2","RuralPop.s2", "PctUrban.s2","PctRural.s2",
      "Prior", "Observed", "MeanOccuProb", 
  #STEP #2 DEMOGRAPHIC RATES
      "Pct_deltaPop12", "Pct_deltaPop01", "r12_Pert", "r01_Pert",
      "r23_Pert", "rPert", "rPert0", "rPert2", 
      "Pct_UrbdeltaPop12", "Pct_UrbdeltaPop01", "Urb_r12_Pert", "Urb_r01_Pert",
      "Urb_r23_Pert", "Urb_rPert", "Urb_rPert0", "Urb_rPert2",
      "Abs_rPert","RS_rPert","LogRS_rPert","LogAbs_rPert","Q.rPert","Q.Abs_rPert",
      "Q.RS_rPert","Q.LogRS_rPert","Q.LogAbs_rPert","Urb_Abs_rPert",
      "Urb_RS_rPert","Urb_LogRS_rPert","Urb_LogAbs_rPert","Q.Urb_rPert","Q.Urb_Abs_rPert",
      "Q.Urb_RS_rPert","Q.Urb_LogRS_rPert","Q.Urb_LogAbs_rPert",
      "Qp.rPert","Qp.Abs_rPert","Qp.RS_rPert","Qp.LogRS_rPert","Qp.LogAbs_rPert",
  #STEP #1 DEMOGRAPHIC VARIABLES
      "Population.s1","PopDens.s1","UrbanScale.s1","UrbanPop.s1","RuralPop.s1", 
      "PctUrban.s1","PctRural.s1",
  #CONTINUITY VARIABLES
      "AreaBwCont","AreaFwCont","PopBwCont","PopFwCont","FwOvlp.Sites",
      "FwOvlp.Area","FwOvlp.Pop","BwOvlp.Sites","BwOvlp.Area","BwOvlp.Pop",
  #PERSISTENCE VARIABLES
      "Found","FoundInit","Abandon","Persist","DewarType",
      "OccuTime","OccuInertia","UrbOccuTime","UrbOccuInertia",
  #STEP #4 TRANSPORT NETWORK VARIABLES
      "TranspDens.pct", "TranspDens.rank","centr_deg","centr_btw","centr_eig",
      "centr_clos","centr_hrmo","centr_hub","centr_auth","centr_pgrk",
      "centr_deg_n","centr_btw_n","centr_eig_n","centr_clos_n","centr_hrmo_n",
      "centr_hub_n","centr_auth_n","centr_avg","trans_loc","trans_locavg",
      "density","connectiv","trans_glob","cntrlz_deg","cntrlz_btw","cntrlz_eig",
      "cntrlz_clo","cntrlz_hub","cntrlz_auth","cntrlz_deg_n","cntrlz_btw_n",
      "cntrlz_eig_n","cntrlz_clo_n","cntrlz_hub_n","cntrlz_auth_n","cntrlz_avg",
  #STEP #4 CATCHMENT AREA AND POP DENSITY VARIABLES
      "Catchment_ha", "CatchmentBeyond_ha", "Catch_Popdens", 
      "Catch_Popdens_PropMax","Catch_Popdens_Rank","CatchB_Popdens",
      "CatchB_Popdens_PropMax", "CatchB_Popdens_Rank", 
  #STEP #5 CATCHMENT ENVIRONMENT/TOPOGRAPHY VARIABLES
      "NPP.tot","NPP.avg","EZ.avg","EZ.sd","TRI.tot","TRI.avg","IrrigPot.tot",
      "IrrigPot.avg","WetAgPot.tot","WetAgPot.avg","IntnsCost.tot",
      "IntnsCost.avg","IntnsCostNW.tot","IntnsCostNW.avg","AGPot.tot",
      "AGPot.avg","AGPotNW.tot","AGPotNW.avg","PopPressure","PopPressureNW",
      "ErosionPot.tot","ErosionPot.avg", 
  #STEP #6 SETTLEMENT HIERARCHY DEMOG VARS
      "SetHierLevel","ScalResid","ScalSlope","ScalInt","Pop_PropMax","Pop_Rank",
      "UrbanPop_PropMax","UrbanPop_Rank","PopDens_PropMax","PopDens_Rank",
      "UrbanScale_PropMax","UrbanScale_Rank",
  #STEP #6 SETTLEMENT HIERARCHY/DEMOG LOCATION QUOTIENTS
      "LQ_UrbPop","FLQ_UrbPop","LQ_UrbOccuTime","FLQ_UrbOccuTime","LQ_UrbOccuInertia",
      "FLQ_UrbOccuInertia","LQ_PopFwCont","LQ_PopBwCont","LQ_AreaFwCont","LQ_AreaBwCont",
      #"LQ_Pct_UrbdeltaPop12","FLQ_Pct_UrbdeltaPop12","LQ_PopDens",
      #"FLQ_PopDens","LQ_Catch_Popdens","FLQ_Catch_Popdens","LQ_Urb_Abs_rPert",
      #"FLQ_Urb_Abs_rPert","LQ_Q.Urb_rPert","FLQ_Q.Urb_rPert",
  #STEP #6 SETTLEMENT HIERARCHY/DEMOG SPATIAL GINIS
      "spGini_Pop","spGini_UrbPop","spGini_OccuTime","spGini_UrbOccuTime",
      "spGini_OccuInertia","spGini_UrbOccuInertia","spGini_Pct_deltaPop12",
      'spGini_Pct_UrbdeltaPop12',"spGini_Area_ha","spGini_Catchment_ha",
      "spGini_Abs_rPert","spGini_Urb_Abs_rPert","spGini_Q.rPert","spGini_Q.Urb_rPert",
      "spGini_FwOvlp.Pop","spGini_BwOvlp.Pop","spGini_FwOvlp.Area","spGini_BwOvlp.Area",
      "spGini_PopPressure",
  #STEP #6 TRANSPORT NETWORK SPATIAL GINIS
      "spGini_centr_avg","spGini_centr_deg","spGini_centr_btw",
      "spGini_centr_eig","spGini_centr_clos","spGini_centr_hrmo","spGini_centr_hub",
      "spGini_centr_auth","spGini_centr_pgrk","spGini_trans_loc","spGini_SetHierLevel",
  #SURVEY METADATA
      "M_Sites","M_SiteCode","M_SiteName","M_FieldSite.Region",
      "M_FieldSite.Period","M_SurveyYearNumber","M_Supervisor","M_Map",
  #OLD tDAR BOM SURVEY VARIABLES
      "O_Elev","O_ElevMed","O_ElevMin","O_ElevMax","O_EZcode",
      "O_EnvironmentalZone","O_Soil","O_SoilMed","O_SoilMin","O_SoilMax",
      "O_Erosion","O_ErosionMed","O_ErosionMin","O_ErosionMax","O_ModernUse",
      "O_ModernSettlement","O_Rainfall","O_Area","O_MoundDomestic",
      "O_MoundCeremonial","O_MoundQuestionable","O_MoundTotal",
      "O_MoundRecorded","O_DMoundArea","O_Architecture","O_TerraceConfidence",
      "O_TerraceExtent","O_Sherd","O_SherdMed","O_SherdMin","O_SherdMax",
      "O_Rubble","O_RubbleMed","O_RubbleMin","O_RubbleMax","O_Population",
      "O_PopMin","O_PopMax","O_PopMethod","O_stcode","O_SiteType",
      "O_SubPeriod1","O_SubPeriod2","O_OccEF","O_OccMF","O_OccLF","O_OccTF",
      "O_OccCL","O_OccEC","O_OccMC","O_OccLC","O_OccET","O_OccLT","O_OccAZ",
      "O_OccEA","O_OccLA","O_OccTot","O_OccSeqLoc","O_SubOc1","O_SubOc2",
      "O_PdDupSite","O_Group","O_Comments") 

#Make sure everything is kosher
#setdiff(colnames(All_Agg_CatchPoly@data),ordering)
#setdiff(colnames(All_Agg_SitePoly@data),ordering)
#setdiff(ordering,colnames(All_Agg_CatchPoly@data))
#setdiff(ordering,colnames(All_Agg_SitePoly@data))

# Reorder the data for both sites and catchment areas
All_Agg_SitePoly@data <- All_Agg_SitePoly@data %>% select(!!!syms(ordering))
All_Agg_CatchPoly@data <- All_Agg_CatchPoly@data %>% select(!!!syms(ordering))
```


# Export Data for Script #8

```{r, 'Export Data for Step #8', message=FALSE,warning=FALSE}

#AggSite polygons
writeOGR(All_Agg_SitePoly, paste0(dir2,"SBOM_AggSitePoly7.gpkg"), "SBOM_AggSitePoly7", driver = "GPKG", overwrite_layer=TRUE)

#Catchment areas
writeOGR(All_Agg_CatchPoly, paste0(dir2,"SBOM_CatchPoly7.gpkg"), "SBOM_CatchPoly7", driver = "GPKG", overwrite_layer=TRUE)

```


# References
